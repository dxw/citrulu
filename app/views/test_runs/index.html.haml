.page
  %h1 Results
  - if @recent_failed_groups.empty?
    %h2.all_pass All your tests are passing. Hooray!
  - else
    .recentfails
      %h2="#{pluralize(@recent_failed_groups.count, 'test')} on #{pluralize(@recent_failed_groups.collect{|g| g.test_url}.uniq.count, 'page')} failed"
      - @recent_failed_groups.each_slice(3).each do |fail_batch|
        .row
          - fail_batch.each do |group|
            .span4
              .fail
                %h3=group.test_url
                %p.last-updated="#{group.updated_at} from #{group.test_run.test_file.name}"
                - if !group.message.blank?
                  %div
                    %p Uh-oh! We couldn't fetch this page because of an error:
                    %pre=group.message
                -else
                  %ul.recentfails
                    -group.test_results.each do |result|
                      - next if !result.failed?
                      %li 
                        %i.icon-remove
                        %span.assertion
                          = result.assertion
                        = value_or_name(result)

  .row
    .testruns.span8
      %h1 Previous test runs
      %ul.unstyled
        - @test_runs.each do |test_run|
          %li
            %a{:href => test_run_path(test_run), :class => test_run.number_of_failures == 0 ? 'pass' : 'fail'}
              %p
                %span.date=test_run.time_run.to_s(:test_run_time)
                %span.file=test_run.test_file.name
              %p.summary="Ran #{pluralize(test_run.number_of_checks, 'check')} on #{pluralize(test_run.number_of_pages, 'page')} with #{pluralize(test_run.number_of_failures, 'failure')}"

    .sidebar.span4
      %h1 Test files status
      %ul.unstyled
        - @test_files.each do |file|
          - if file.test_file_text == file.compiled_test_file_text 
            %li.pass 
              %h3=file.name
              %p.summary="This file is working and was last executed on #{file.last_run.time_run}"
              %a{:href => edit_test_file_path(file)} Edit this file
          - else
            %li.fail
              %h3=file.name
              %p.summary This file is not compiling successfully. 
              %p.summary Tests are being executed based on the <a href="">last successfully compiled file</a>, dated 10th March 2012.  TODO
              %p.summary="Those tests were last executed on #{file.last_run.time_run}"
              %a{:href => edit_test_file_path(file)} Edit this file
   
-#%h1 Test Runs
-#- if @test_runs.empty?
  %p You don't have any test runs to show yet
-#-else
  .row
    .span6
      =accordion("test_runs_list") do
        - @test_runs.each do |test_run|
          =accordion_group("test_run_#{test_run.id}") do
            =accordion_heading({:class => test_run.status}) do
              %time
                = test_run.time_run.to_s(:test_run_time)
              %span.outcome
                - if test_run.number_of_failures == 0
                  Everything works!
                - else
                  = test_run.number_of_failures
                  failures
            =accordion_body do
              %p 
                ="Ran #{test_run.number_of_checks} checks on #{test_run.number_of_pages} pages, of which #{test_run.number_of_failures} failed"
              %ul.unstyled
                - test_run.test_groups.each do |test_group|
                  %li
                    0n 
                    = link_to test_group.test_url, nil , :target => "_blank"
                    %ul.unstyled
                      -test_group.test_results.each do |test_result|
                        %li{ :class => "test_result #{test_class(test_result)}"}
                          %span.assertion
                            = test_result.assertion
                          = value_or_name(test_result)
              %p.close_link
                %a{ "data-parent" => "#test_runs_list", "data-target"=> "##{test_run.time_run.to_i}", "data-toggle" => "collapse"} Close
